@page "/healthcheck"
@attribute [Authorize(Roles = "Admin,SuperUser")]
@using System.Text.RegularExpressions
@using OpenAI.Embeddings
@using ChatUiT2.Interfaces
@using ChatUiT2.Services

<MudText Typo="Typo.h5">Applikasjonstilstand</MudText>

<MudPaper Class="mt-4 pa-4" Elevation="3">
    Tester forbindelse til eksterne dependencies. 123
</MudPaper>

<HealthCheckRagDbStatus></HealthCheckRagDbStatus>

<HealthCheckChatDbStatus></HealthCheckChatDbStatus>
  
<HealthCheckOpenAiStatus></HealthCheckOpenAiStatus>

<MudPaper Class="mt-4 pa-4" Elevation="3">
    <MudText Typo="Typo.h6">Mq status</MudText>
    <MudText>Hostname: @mqHost</MudText>
    <MudText>Virtualhost: @mqVhost</MudText>
    <MudText>Port: @mqPort</MudText>
    <MudText>Exchange: @mqExchange</MudText>
    <MudText>Username: @mqUsername</MudText>
    <MudText>Password has value: @mqPasswordHasValue</MudText>
    @if (mqStatusLoading)
    {
        <MudText>Testing rabbitMq connection</MudText>
        <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
    }
    else
    {
        <MudText Class="mt-4">@mqError</MudText>
        @if (string.IsNullOrEmpty(mqError) == true)
        {
            <MudText>RabbitMq queue count: @mqCount</MudText>
        }
    }
</MudPaper>

<MudPaper Class="mt-4 pa-4" Elevation="3">
    <MudText Typo="Typo.h6">Config variables</MudText>
    <MudText>Environment: @aspnetCoreEnv</MudText>
    <MudText>Keyvault: @keyVaultName</MudText>
    <MudText>OpenAi endpoint: @openAiEndpoint</MudText>
</MudPaper>

<MudPaper Class="mt-4 pa-4" Elevation="3">
    <MudText Typo="Typo.h6">DefaultModel</MudText>
    <MudText>DeploymentName: @defaultModel?.DeploymentName</MudText>
    <MudText>Name: @defaultModel?.DisplayName</MudText>
    <MudText>Deployment: @defaultModel?.Endpoint</MudText>
</MudPaper>

<MudPaper Class="mt-4 pa-4" Elevation="3">
    <MudText Typo="Typo.h6">NamingModel</MudText>
    <MudText>DeploymentName: @namingModel?.DeploymentName</MudText>
    <MudText>Name: @namingModel?.DisplayName</MudText>
    <MudText>Deployment: @namingModel?.Endpoint</MudText>
</MudPaper>

@foreach (var endpoint in modelEndpoints)
{
    <MudPaper Class="mt-4 pa-4" Elevation="3">
        <MudText Typo="Typo.h6">ModelEndpoint</MudText>
        <MudText>Name: @endpoint?.Name</MudText>
        <MudText>Url: @endpoint?.Url</MudText>
    </MudPaper>
}


@code {
    [Inject] IConfiguration configuration { get; set; }
    [Inject] ISettingsService settingsService { get; set; }
    [Inject] IDatabaseService databaseService { get; set; }
    [Inject] IUserService userService { get; set; }
    [Inject] ILogger<UserService> userLogger { get; set; }
    [Inject] IRabbitMqService rabbitMqService { get; set; }
    [Inject] IRagDatabaseService ragDatabaseService { get; set; }

    private string keyVaultName = string.Empty;
    private string aspnetCoreEnv = string.Empty;

    private AiModel? defaultModel = null;
    private ModelConfig? defaultModelConfig = null;
    private AiModel? embeddingModel = null;
    private ModelConfig? embeddingModelConfig = null;
    private AiModel? namingModel = null;
    private string openAiEndpoint = string.Empty;

    private string mqVhost = string.Empty;
    private string mqHost = string.Empty;
    private string mqPort = string.Empty;
    private string mqExchange = string.Empty;
    private string mqUsername = string.Empty;
    private bool mqPasswordHasValue = false;
    private uint mqCount;
    private string? mqError;
    private bool mqStatusLoading = true;

    private List<ModelEndpoint> modelEndpoints = [];

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            CheckKeyVault();
            CheckEnv();
            checkModels();
            checkEndpointsConfig();
            CheckRabbitMq();
            StateHasChanged();
        }
    }

    private void checkEndpointsConfig()
    {
        var endpointSection = configuration.GetSection("Endpoints");
        modelEndpoints = endpointSection.Get<List<ModelEndpoint>>() ?? [];
    }

    private void checkModels()
    {
        defaultModel = settingsService.DefaultModel;
        embeddingModel = settingsService.EmbeddingModel;
        namingModel = settingsService.NamingModel;

        var modelSection = configuration.GetSection("Models");
        var models = modelSection.Get<List<ModelConfig>>();
        embeddingModelConfig = models?.FirstOrDefault(m => m.DisplayName == embeddingModel.DisplayName);
        defaultModelConfig = models?.FirstOrDefault(m => m.DisplayName == defaultModel.DisplayName);
    }

    private void CheckKeyVault()
    {
        keyVaultName = configuration.GetConnectionString("KeyVault");
    }

    private void CheckEnv()
    {
        aspnetCoreEnv = configuration["ASPNETCORE_ENVIRONMENT"];
    }

    private string? GetConnectionStringForDisplay(string connectionString)
    {
        var connStrDebug = Regex.Replace(connectionString, "//.+?@", "//xxxxx:xxxxx@");
        return connStrDebug;
    }


    private async Task CheckRabbitMq()
    {
        mqStatusLoading = true;
        mqVhost = configuration["RabbitMq:VirtualHost"];
        mqHost = configuration["RabbitMq:HostName"];
        mqPort = configuration["RabbitMq:Port"];
        mqExchange = configuration["RabbitMq:ExchangeName"];
        mqUsername = configuration["RabbitMq:Username"];
        mqPasswordHasValue = string.IsNullOrEmpty(configuration["RabbitMq:Password"]) == false;
        try
        {
            mqCount = await rabbitMqService.GetQueueCount(configuration["RabbitMq:CreateItemEmbeddingQueueName"] ?? "MissingQueue");
        }
        catch (Exception e)
        {
            mqError = $"Error getting count from rabbitMq queue: {e.Message}";
        }
        mqStatusLoading = false;
        StateHasChanged();
    }
}
